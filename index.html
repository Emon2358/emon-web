<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Web VJ - Chroma Delay Simulator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background-color: #111;
            color: #0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 1em;
            overflow: hidden;
            height: 100vh;
        }

        h1 {
            color: #f0f;
            text-shadow: 0 0 5px #f0f, 0 0 10px #f0f;
            margin-bottom: 0.5em;
            text-align: center;
        }

        #video-container {
            position: relative;
            background: #000;
            border: 2px solid #0f0;
            box-shadow: 0 0 15px #0f0 inset;
            /* å›ºå®šã‚µã‚¤ã‚º */
            width: 640px;
            height: 480px;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* ã‚½ãƒ¼ã‚¹ã¨ãªã‚‹videoè¦ç´ ã¯éè¡¨ç¤º */
        video {
            display: none;
        }

        #controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #0a0;
            max-width: 90%;
        }

        .input-group, .slider-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: 250px;
            min-width: 150px;
            flex-grow: 1;
        }

        label {
            font-size: 0.9em;
            margin-bottom: 5px;
            color: #0f0;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #333;
            outline: none;
            border: 1px solid #0f0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #f0f;
            border: 2px solid #0f0;
            cursor: pointer;
            box-shadow: 0 0 10px #f0f;
        }
        
        input[type="file"] {
            background: #333;
            border: 1px solid #0f0;
            color: #f0f;
            padding: 5px;
            width: calc(100% - 12px);
            margin-bottom: 5px;
        }

        input[type="file"]::file-selector-button {
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 5px 10px;
            cursor: pointer;
        }

        button {
            background: #111;
            color: #f0f;
            border: 2px solid #f0f;
            padding: 10px 20px;
            font-size: 1em;
            font-family: inherit;
            cursor: pointer;
            text-shadow: 0 0 5px #f0f;
            transition: all 0.2s;
            margin-top: 10px;
        }

        button:hover {
            background: #f0f;
            color: #111;
            box-shadow: 0 0 15px #f0f;
        }
    </style>
</head>
<body>

    <h1>Web VJ - Chroma Delay Simulator ğŸ“¼</h1>

    <div id="video-container">
        <canvas id="outputCanvas" width="640" height="480"></canvas>
    </div>

    <div id="controls">
        <div class="input-group">
            <button id="startCam">CAM START</button>
        </div>

        <div class="input-group">
            <label for="fileInput">VIDEO FILES (è¤‡æ•°é¸æŠå¯)</label>
            <input type="file" id="fileInput" accept="video/*" multiple>
        </div>
        
        <div class="input-group">
            <label for="urlInput">VIDEO URL (å¤–éƒ¨URL)</label>
            <input type="text" id="urlInput" placeholder="CORSå¯¾å¿œURLã®ã¿">
            <button id="loadURL">URLã‚’èª­ã¿è¾¼ã‚€</button>
        </div>

        <div class="slider-group" style="width: 100%;">
            <label for="colorShift">CHROMA DELAY (è‰²ä¿¡å·é…å»¶)</label>
            <input type=range id="colorShift" min="0" max="100" value="0">
        </div>
    </div>

    <script>
        const canvas = document.getElementById('outputCanvas');
        // 2Dã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸€åº¦ã ã‘å–å¾—
        const ctx = canvas.getContext('2d', { willReadFrequently: true });

        const startCamButton = document.getElementById('startCam');
        const fileInput = document.getElementById('fileInput');
        const urlInput = document.getElementById('urlInput');
        const loadURLButton = document.getElementById('loadURL');

        // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
        const colorSlider = document.getElementById('colorShift');

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚º (å›ºå®š)
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;

        let animationFrameId;
        
        // å‹•ä½œä¸­ã®ãƒ“ãƒ‡ã‚ªã‚½ãƒ¼ã‚¹ã‚’ç®¡ç†ã™ã‚‹é…åˆ—
        let activeSources = [];

        // 1. Webã‚«ãƒ¡ãƒ©ã®èµ·å‹•
        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: canvasWidth, height: canvasHeight },
                    audio: false
                });
                const webcamVideo = document.createElement('video');
                webcamVideo.srcObject = stream;
                webcamVideo.autoplay = true;
                webcamVideo.playsinline = true;
                webcamVideo.muted = true;
                
                await webcamVideo.play();
                
                startCamButton.textContent = "CAM RUNNING...";
                startCamButton.disabled = true;
                
                activeSources.push(webcamVideo);

                // æç”»ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
                if (!animationFrameId) {
                    animationFrameId = requestAnimationFrame(processFrame);
                }

            } catch (err) {
                console.error("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ:", err);
                alert("ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨±å¯è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        }
        startCamButton.addEventListener('click', startWebcam);

        // 2. ãƒ­ãƒ¼ã‚«ãƒ«å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ (è¤‡æ•°å¯¾å¿œ)
        fileInput.addEventListener('change', (event) => {
            const files = event.target.files;
            if (!files) return;

            for (const file of files) {
                const objectURL = URL.createObjectURL(file);
                const fileVideo = document.createElement('video');
                fileVideo.src = objectURL;
                fileVideo.autoplay = true;
                fileVideo.playsinline = true;
                fileVideo.loop = true;
                fileVideo.muted = true;

                fileVideo.play().catch(e => console.error("Video file play error:", e));
                
                activeSources.push(fileVideo);
            }
            
            // æç”»ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
            if (files.length > 0 && !animationFrameId) {
                animationFrameId = requestAnimationFrame(processFrame);
            }
        });

        // 3. å‹•ç”»URLã®èª­ã¿è¾¼ã¿
        loadURLButton.addEventListener('click', () => {
            const url = urlInput.value.trim();
            if (url) {
                const urlVideo = document.createElement('video');
                urlVideo.src = url;
                urlVideo.autoplay = true;
                urlVideo.playsinline = true;
                urlVideo.loop = true;
                urlVideo.muted = true;
                urlVideo.crossOrigin = "anonymous"; // CORSå¯¾å¿œ

                urlVideo.play().catch(e => {
                    console.error("Video URL play error:", e);
                    alert("URLå‹•ç”»ã®èª­ã¿è¾¼ã¿ãƒ»å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚CORSã®å•é¡ŒãŒãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                });
                
                activeSources.push(urlVideo);

                // æç”»ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
                if (!animationFrameId) {
                    animationFrameId = requestAnimationFrame(processFrame);
                }
            }
        });

        // 4. æ¯ãƒ•ãƒ¬ãƒ¼ãƒ ã®å‡¦ç†
        function processFrame() {
            // ã‚½ãƒ¼ã‚¹ãŒãªã‘ã‚Œã°åœæ­¢
            if (activeSources.length === 0) {
                 animationFrameId = null;
                 return;
            }
            
            // A. ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢ (ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ç¶­æŒã®ãŸã‚)
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            let allSourcesReady = true;

            // B. è¤‡æ•°ã®ã‚½ãƒ¼ã‚¹ã‚’ãƒªã‚µã‚¤ã‚ºã—ã¦é‡ã­ã¦æç”»
            for (let i = 0; i < activeSources.length; i++) {
                const source = activeSources[i];
                if (source && !source.paused && !source.ended && source.videoWidth > 0) {
                    
                    // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã¦ãƒªã‚µã‚¤ã‚º (Contain)
                    const videoWidth = source.videoWidth;
                    const videoHeight = source.videoHeight;
                    const ratio = Math.min(canvasWidth / videoWidth, canvasHeight / videoHeight);
                    const newWidth = videoWidth * ratio;
                    const newHeight = videoHeight * ratio;
                    
                    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ä¸­å¤®ã«é…ç½®
                    const x = (canvasWidth - newWidth) / 2;
                    const y = (canvasHeight - newHeight) / 2;

                    ctx.drawImage(source, x, y, newWidth, newHeight);
                } else if (!source || source.videoWidth === 0) {
                    allSourcesReady = false; // ã¾ã ãƒ­ãƒ¼ãƒ‰ä¸­
                }
            }

            // C. ãƒ”ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            let imageData;
            try {
                // imageDataã¯ã‚­ãƒ£ãƒ³ãƒã‚¹å…¨ä½“ã‹ã‚‰å–å¾— (640x480)
                imageData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
            } catch (e) {
                console.error("ImageDataã®å–å¾—ã«å¤±æ•— (CORSãªã©):", e);
                // URLå‹•ç”»ã®å ´åˆã€ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³åˆ¶ç´„ã«ã‚ˆã‚ŠImageDataã®å–å¾—ãŒã§ããªã„ã“ã¨ãŒã‚ã‚‹
                animationFrameId = requestAnimationFrame(processFrame);
                return;
            }

            // D. ã‚°ãƒªãƒƒãƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆè‰²ä¿¡å·é…å»¶ï¼‰ã®é©ç”¨
            const colorAmount = parseInt(colorSlider.value, 10);
            if (colorAmount > 0) {
                applyChromaDelay(imageData.data, canvasWidth, colorAmount);
            }

            // E. å‡¦ç†å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’canvasã«æ›¸ãæˆ»ã™
            ctx.putImageData(imageData, 0, 0);

            // F. æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¦æ±‚
            animationFrameId = requestAnimationFrame(processFrame);
        }

        // 5. è‰²ä¿¡å·é…å»¶ (Chroma Delay) ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        // è¼åº¦(Y)ã¯ãã®å ´ã«ç•™ã‚ã€è‰²æƒ…å ±(U, V)ã‚’éå»(å·¦)ã®ãƒ”ã‚¯ã‚»ãƒ«ã‹ã‚‰æŒã£ã¦ãã‚‹
        function applyChromaDelay(data, width, amount) {
            // amount (0-100) ã«å¿œã˜ã¦ã€è‰²ã‚’ã‚ºãƒ©ã™ãƒ”ã‚¯ã‚»ãƒ«æ•° (shift) ã‚’æ±ºå®š
            const shift = Math.floor(amount / 5); // 0-20 ãƒ”ã‚¯ã‚»ãƒ«
            if (shift === 0) return;

            // è¼åº¦è¨ˆç®—ã®ä¿‚æ•° (BT.601)
            const Y_R = 0.299;
            const Y_G = 0.587;
            const Y_B = 0.114;

            // YUV -> RGB å¤‰æ›ã®ä¿‚æ•° (æ¦‚ç®—)
            const V_R = 1.140;
            const U_G = -0.395;
            const V_G = -0.581;
            const U_B = 2.032;

            // 1è¡Œåˆ†ã®è‰²æƒ…å ±(U, V)ã‚’ãƒãƒƒãƒ•ã‚¡ã™ã‚‹
            let lineChroma = new Float32Array(width * 2); // [U0, V0, U1, V1, ...]
            let x_idx = 0;

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // 1. ç¾åœ¨ã®ãƒ”ã‚¯ã‚»ãƒ«ã®è¼åº¦(Y)ã‚’è¨ˆç®—
                const y_curr = Y_R * r + Y_G * g + Y_B * b;

                // 2. ç¾åœ¨ã®ãƒ”ã‚¯ã‚»ãƒ«ã®è‰²å·®(U, V)ã‚’è¨ˆç®—ã—ã€ãƒãƒƒãƒ•ã‚¡ã«ä¿å­˜
                // YUVã®U,Vè¨ˆç®— (æ¦‚ç®—)
                const u_curr = 0.492 * (b - y_curr);
                const v_curr = 0.877 * (r - y_curr);
                
                lineChroma[x_idx * 2] = u_curr;
                lineChroma[x_idx * 2 + 1] = v_curr;

                // 3. é…å»¶ã•ã›ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹(éå»)ã‚’è¨ˆç®—
                let chroma_idx = x_idx - shift;
                if (chroma_idx < 0) chroma_idx = 0; // è¡Œã®å·¦ç«¯ã‚ˆã‚Šå‰ã¯å‚ç…§ã—ãªã„

                // 4. éå»ã®è‰²æƒ…å ±(U_delay, V_delay)ã‚’å–å¾—
                const u_delay = lineChroma[chroma_idx * 2];
                const v_delay = lineChroma[chroma_idx * 2 + 1];

                // 5. ã€Œç¾åœ¨ã®è¼åº¦(Y_curr)ã€ã¨ã€Œéå»ã®è‰²(U_delay, V_delay)ã€ã§RGBã‚’å†åˆæˆ
                let new_r = y_curr + V_R * v_delay;
                let new_g = y_curr + U_G * u_delay + V_G * v_delay;
                let new_b = y_curr + U_B * u_delay;

                // 0-255 ã®ç¯„å›²ã«ã‚¯ãƒªãƒƒãƒ—
                data[i]     = Math.max(0, Math.min(255, new_r));
                data[i + 1] = Math.max(0, Math.min(255, new_g));
                data[i + 2] = Math.max(0, Math.min(255, new_b));
                // data[i + 3] (Alpha) ã¯å¤‰æ›´ã—ãªã„

                // æ°´å¹³ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹(x)ã‚’æ›´æ–°
                x_idx++;
                if (x_idx === width) {
                    x_idx = 0; // æ¬¡ã®è¡Œã¸
                    // è¡ŒãŒå¤‰ã‚ã£ãŸã‚‰è‰²ãƒãƒƒãƒ•ã‚¡ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆè¡Œã‚’ã¾ãŸã„ã§è‰²ãŒã‚ºãƒ¬ãªã„ã‚ˆã†ã«ï¼‰
                    lineChroma.fill(0);
                }
            }
        }
    </script>

</body>
</html>
