<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Web VJ - Glitch Crusher EX</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background-color: #111;
            color: #0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 1em;
            overflow: hidden;
            height: 100vh;
        }

        h1 {
            color: #f0f;
            text-shadow: 0 0 5px #f0f, 0 0 10px #f0f;
            margin-bottom: 0.5em;
            text-align: center;
        }

        #video-container {
            position: relative;
            background: #000;
            border: 2px solid #0f0;
            box-shadow: 0 0 15px #0f0 inset;
            min-width: 640px;
            min-height: 480px;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* „ÇΩ„Éº„Çπ„Å®„Å™„ÇãvideoË¶ÅÁ¥†„ÅØÈùûË°®Á§∫„Å´„Åô„Çã */
        #webcam, #videoFile, #videoURL {
            display: none;
        }

        #controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #0a0;
            max-width: 90%;
            overflow-x: auto;
        }

        .input-group, .slider-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Â∑¶ÂØÑ„Åõ */
            width: 250px;
            min-width: 150px;
            flex-grow: 1; /* Ê®™ÂπÖ„ÅÑ„Å£„Å±„ÅÑ„Å´Â∫É„Åå„Çã */
        }

        label {
            font-size: 0.9em;
            margin-bottom: 5px;
            color: #0f0;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #333;
            outline: none;
            border: 1px solid #0f0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #f0f;
            border: 2px solid #0f0;
            cursor: pointer;
            box-shadow: 0 0 10px #f0f;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #f0f;
            border: 2px solid #0f0;
            cursor: pointer;
            box-shadow: 0 0 10px #f0f;
        }

        input[type="file"], input[type="text"] {
            background: #333;
            border: 1px solid #0f0;
            color: #f0f;
            padding: 5px;
            width: calc(100% - 12px); /* padding„Å®borderÂàÜ„ÇíÂºï„Åè */
            margin-bottom: 5px;
        }

        input[type="file"]::file-selector-button {
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 5px 10px;
            cursor: pointer;
        }

        button {
            background: #111;
            color: #f0f;
            border: 2px solid #f0f;
            padding: 10px 20px;
            font-size: 1em;
            font-family: inherit;
            cursor: pointer;
            text-shadow: 0 0 5px #f0f;
            transition: all 0.2s;
            margin-top: 10px;
        }

        button:hover {
            background: #f0f;
            color: #111;
            box-shadow: 0 0 15px #f0f;
        }

        .separator {
            width: 100%;
            height: 1px;
            background: #0a0;
            margin: 10px 0;
        }
    </style>
</head>
<body>

    <h1>Web VJ - Glitch Crusher EX ÂªÉÊùê„Ç®„Éá„Ç£„Ç∑„Éß„É≥ üìº</h1>

    <div id="video-container">
        <canvas id="outputCanvas"></canvas>
        <video id="webcam" autoplay playsinline muted></video>
        <video id="videoFile" autoplay playsinline loop muted></video>
        <video id="videoURL" autoplay playsinline loop muted crossorigin="anonymous"></video>
    </div>

    <div id="controls">
        <div class="input-group">
            <button id="startCam">CAM START</button>
        </div>

        <div class="input-group">
            <label for="fileInput">VIDEO FILE („É≠„Éº„Ç´„É´„Éï„Ç°„Ç§„É´)</label>
            <input type="file" id="fileInput" accept="video/*">
        </div>
        
        <div class="input-group">
            <label for="urlInput">VIDEO URL (Â§ñÈÉ®URL)</label>
            <input type="text" id="urlInput" placeholder="‰æã: https://example.com/video.mp4">
            <button id="loadURL">URL„ÇíË™≠„ÅøËæº„ÇÄ</button>
        </div>

        <div class="separator"></div>

        <div class="slider-group">
            <label for="glitchAmount">DATA CRASH („Éá„Éº„ÇøÁ†¥Â£ä)</label>
            <input type=range id="glitchAmount" min="0" max="100" value="0">
        </div>
        <div class="slider-group">
            <label for="syncLoss">SYNC LOSS (ÂêåÊúü„Ç∫„É¨)</label>
            <input type=range id="syncLoss" min="0" max="100" value="0">
        </div>
        <div class="slider-group">
            <label for="colorShift">COLOR BLEED (Ëâ≤„Ç∫„É¨)</label>
            <input type=range id="colorShift" min="0" max="100" value="0">
        </div>
        <div class="slider-group">
            <label for="noiseAmount">STATIC NOISE (Á†ÇÂµê„Éé„Ç§„Ç∫)</label>
            <input type=range id="noiseAmount" min="0" max="100" value="0">
        </div>
         <div class="slider-group">
            <label for="feedbackAmount">VIDEO FEEDBACK (Êò†ÂÉè„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ)</label>
            <input type=range id="feedbackAmount" min="0" max="100" value="0">
        </div>
        <div class="slider-group">
            <label for="opacityMix">SOURCE MIX („ÇΩ„Éº„ÇπÂêàÊàêÂº∑Â∫¶)</label>
            <input type=range id="opacityMix" min="0" max="100" value="50">
        </div>
    </div>

    <script>
        const webcamVideo = document.getElementById('webcam');
        const fileVideo = document.getElementById('videoFile');
        const urlVideo = document.getElementById('videoURL');
        const canvas = document.getElementById('outputCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });

        const startCamButton = document.getElementById('startCam');
        const fileInput = document.getElementById('fileInput');
        const urlInput = document.getElementById('urlInput');
        const loadURLButton = document.getElementById('loadURL');

        // „Ç≥„É≥„Éà„É≠„Éº„É´
        const glitchSlider = document.getElementById('glitchAmount');
        const syncSlider = document.getElementById('syncLoss');
        const colorSlider = document.getElementById('colorShift');
        const noiseSlider = document.getElementById('noiseAmount');
        const feedbackSlider = document.getElementById('feedbackAmount');
        const opacityMixSlider = document.getElementById('opacityMix');

        let videoWidth = 640;
        let videoHeight = 480;
        let animationFrameId;

        // ÁèæÂú®„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„ÇΩ„Éº„Çπ„ÇíËøΩË∑°
        let activeSources = [];

        // 1. Web„Ç´„É°„É©„ÅÆËµ∑Âãï
        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: videoWidth, height: videoHeight },
                    audio: false
                });
                webcamVideo.srcObject = stream;
                await webcamVideo.play();
                startCamButton.textContent = "CAM RUNNING...";
                startCamButton.disabled = true;
                
                // ÂàùÂõû„ÅÆ„Åø„Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫Ë®≠ÂÆö„Å®ÊèèÁîª„É´„Éº„ÉóÈñãÂßã
                if (!animationFrameId) {
                    webcamVideo.onloadedmetadata = () => {
                        videoWidth = webcamVideo.videoWidth;
                        videoHeight = webcamVideo.videoHeight;
                        canvas.width = videoWidth;
                        canvas.height = videoHeight;
                        if (!animationFrameId) { // ÈáçË§áÈò≤Ê≠¢
                            animationFrameId = requestAnimationFrame(processFrame);
                        }
                    };
                }
                activeSources.push(webcamVideo);

            } catch (err) {
                console.error("„Ç´„É°„É©„ÅÆËµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:", err);
                alert("„Ç´„É°„É©„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®±ÂèØË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            }
        }
        startCamButton.addEventListener('click', startWebcam);

        // 2. „É≠„Éº„Ç´„É´ÂãïÁîª„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const objectURL = URL.createObjectURL(file);
                fileVideo.src = objectURL;
                fileVideo.play().catch(e => console.error("Video file play error:", e));

                // ÂàùÂõû„ÅÆ„Åø„Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫Ë®≠ÂÆö„Å®ÊèèÁîª„É´„Éº„ÉóÈñãÂßã
                if (!animationFrameId) {
                    fileVideo.onloadedmetadata = () => {
                        videoWidth = fileVideo.videoWidth;
                        videoHeight = fileVideo.videoHeight;
                        canvas.width = videoWidth;
                        canvas.height = videoHeight;
                        if (!animationFrameId) { // ÈáçË§áÈò≤Ê≠¢
                            animationFrameId = requestAnimationFrame(processFrame);
                        }
                    };
                }
                activeSources.push(fileVideo);
            }
        });

        // 3. ÂãïÁîªURL„ÅÆË™≠„ÅøËæº„Åø
        loadURLButton.addEventListener('click', () => {
            const url = urlInput.value.trim();
            if (url) {
                urlVideo.src = url;
                urlVideo.play().catch(e => {
                    console.error("Video URL play error:", e);
                    alert("URLÂãïÁîª„ÅÆË™≠„ÅøËæº„Åø„ÉªÂÜçÁîü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇURL„ÅåÊ≠£„Åó„ÅÑ„Åã„ÄÅCORS„ÅÆÂïèÈ°å„Åå„Å™„ÅÑ„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                });

                // ÂàùÂõû„ÅÆ„Åø„Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫Ë®≠ÂÆö„Å®ÊèèÁîª„É´„Éº„ÉóÈñãÂßã
                if (!animationFrameId) {
                    urlVideo.onloadedmetadata = () => {
                        videoWidth = urlVideo.videoWidth;
                        videoHeight = urlVideo.videoHeight;
                        canvas.width = videoWidth;
                        canvas.height = videoHeight;
                        if (!animationFrameId) { // ÈáçË§áÈò≤Ê≠¢
                            animationFrameId = requestAnimationFrame(processFrame);
                        }
                    };
                }
                activeSources.push(urlVideo);
            }
        });

        // 4. ÊØé„Éï„É¨„Éº„É†„ÅÆÂá¶ÁêÜ
        function processFrame() {
            // „ÇΩ„Éº„Çπ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            if (activeSources.length === 0) {
                 animationFrameId = requestAnimationFrame(processFrame);
                 return;
            }

            // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Ç®„Éï„Çß„ÇØ„Éà„ÇíÈÅ©Áî®ÔºàÂâç„Éï„É¨„Éº„É†„ÅÆÁîªÂÉè„ÇíÂ∞ë„ÅóÊÆã„ÅôÔºâ
            const feedbackAmount = parseInt(feedbackSlider.value, 10);
            if (feedbackAmount > 0) {
                ctx.globalAlpha = 1 - (feedbackAmount / 150); // ÊÆãÂÉè„ÅÆÂº∑„Åï
                ctx.drawImage(canvas, 0, 0, videoWidth, videoHeight);
                ctx.globalAlpha = 1;
            } else {
                ctx.clearRect(0, 0, videoWidth, videoHeight); // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Å™„Åó„Å™„Çâ„ÇØ„É™„Ç¢
            }


            // Ë§áÊï∞„ÅÆ„ÇΩ„Éº„Çπ„ÇíÈáç„Å≠„Å¶ÊèèÁîª
            const opacityMix = parseInt(opacityMixSlider.value, 10) / 100;
            let firstSourceDrawn = false;

            for (let i = 0; i < activeSources.length; i++) {
                const source = activeSources[i];
                if (source && !source.paused && !source.ended) {
                    if (!firstSourceDrawn) {
                        ctx.drawImage(source, 0, 0, videoWidth, videoHeight);
                        firstSourceDrawn = true;
                    } else {
                        // 2Áï™ÁõÆ‰ª•Èôç„ÅÆ„ÇΩ„Éº„Çπ„ÅØÈÄèÊòéÂ∫¶„ÇíË™øÊï¥„Åó„Å¶Èáç„Å≠„Çã
                        ctx.globalAlpha = opacityMix;
                        ctx.drawImage(source, 0, 0, videoWidth, videoHeight);
                        ctx.globalAlpha = 1; // ÂÖÉ„Å´Êàª„Åô
                    }
                }
            }
            
            // ÂÖ®„Å¶„ÅÆ„ÇΩ„Éº„Çπ„ÅåÊ≠¢„Åæ„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà
            if (!firstSourceDrawn) {
                animationFrameId = requestAnimationFrame(processFrame);
                return;
            }


            // B. canvas„Åã„Çâ„Éî„ÇØ„Çª„É´„Éá„Éº„Çø„ÇíÂèñÂæó
            let imageData;
            try {
                imageData = ctx.getImageData(0, 0, videoWidth, videoHeight);
            } catch (e) {
                console.error("ImageData„ÅÆÂèñÂæó„Å´Â§±Êïó (CORS„Å™„Å©):", e);
                // URLÂãïÁîª„ÅÆÂ†¥Âêà„ÄÅ„ÇØ„É≠„Çπ„Ç™„É™„Ç∏„É≥Âà∂Á¥Ñ„Å´„Çà„ÇäImageData„ÅÆÂèñÂæó„Åå„Åß„Åç„Å™„ÅÑ„Åì„Å®„Åå„ÅÇ„Çã
                // „Åù„ÅÆÂ†¥Âêà„ÅØ„Ç∞„É™„ÉÉ„ÉÅÂá¶ÁêÜ„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Å¶Ê¨°„ÅÆ„Éï„É¨„Éº„É†„Å∏
                animationFrameId = requestAnimationFrame(processFrame);
                return;
            }

            const data = imageData.data; // „Éî„ÇØ„Çª„É´„Éá„Éº„ÇøÈÖçÂàó (R, G, B, A, R, G, B, A, ...)

            // C. „Ç∞„É™„ÉÉ„ÉÅ„Ç®„Éï„Çß„ÇØ„Éà„ÅÆÈÅ©Áî®
            applyGlitchEffects(data, videoWidth, videoHeight);

            // D. Âá¶ÁêÜÂæå„ÅÆ„Éá„Éº„Çø„Çícanvas„Å´Êõ∏„ÅçÊàª„Åô
            ctx.putImageData(imageData, 0, 0);

            // E. Ê¨°„ÅÆ„Éï„É¨„Éº„É†„ÇíË¶ÅÊ±Ç
            animationFrameId = requestAnimationFrame(processFrame);
        }

        // 5. „Ç∞„É™„ÉÉ„ÉÅ„Ç®„Éï„Çß„ÇØ„ÉàÈñ¢Êï∞Áæ§
        function applyGlitchEffects(data, width, height) {
            const glitchAmount = parseInt(glitchSlider.value, 10);
            const syncAmount = parseInt(syncSlider.value, 10);
            const colorAmount = parseInt(colorSlider.value, 10);
            const noiseAmount = parseInt(noiseSlider.value, 10);

            // „Éë„É©„É°„Éº„Çø„Åå0„Å™„ÇâÂá¶ÁêÜ„Çí„Çπ„Ç≠„ÉÉ„Éó („Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÅØÂà•„ÅßÂá¶ÁêÜ)
            if (glitchAmount === 0 && syncAmount === 0 && colorAmount === 0 && noiseAmount === 0) {
                return;
            }

            // --- DATA CRASH („Éá„Éº„ÇøÁ†¥Â£ä) ---
            if (glitchAmount > 0) {
                const glitchProbability = glitchAmount / 500; // Áô∫ÁîüÁ¢∫Áéá„Çí‰∏ä„Åí„Çã
                const maxBlockSize = Math.floor((height * width * 4) * (glitchAmount / 500)); // „Éñ„É≠„ÉÉ„ÇØ„Çµ„Ç§„Ç∫„ÇÇÂ§ß„Åç„Åè
                const maxOffset = Math.floor((width * height * 4) * (glitchAmount / 400)); // „Ç™„Éï„Çª„ÉÉ„Éà„ÇÇÂ§ß„Åç„Åè

                for (let i = 0; i < data.length; i += 4) {
                    if (Math.random() < glitchProbability) {
                        const blockSize = Math.floor(Math.random() * maxBlockSize);
                        let offset = Math.floor(Math.random() * maxOffset) - (maxOffset / 2);
                        offset = offset - (offset % 4); // 4„Éê„Ç§„Éà(RGBA)Âçò‰Ωç„Å´ÊèÉ„Åà„Çã

                        if (i + offset >= 0 && i + offset < data.length) {
                             const sourceIndex = i + offset;
                             for (let j = 0; j < blockSize && i + j < data.length && sourceIndex + j < data.length; j += 4) {
                                data[i + j]     = data[sourceIndex + j];
                                data[i + j + 1] = data[sourceIndex + j + 1];
                                data[i + j + 2] = data[sourceIndex + j + 2];
                             }
                             i += blockSize; // Âá¶ÁêÜ„Åó„ÅüÂàÜ„Å†„Åë„Ç∏„É£„É≥„Éó
                        }
                    }
                }
            }

            // --- SYNC LOSS (ÂêåÊúü„Ç∫„É¨) ---
            if (syncAmount > 0) {
                const maxShift = Math.floor(width * (syncAmount / 80)); // ÊúÄÂ§ß„Ç∫„É¨ÂπÖ„ÇíÂ§ß„Åç„Åè
                const numLinesToShift = Math.floor(height * (syncAmount / 200)); // „Ç∫„É©„ÅôË°åÊï∞„ÇíÂ¢ó„ÇÑ„Åô

                for(let k = 0; k < numLinesToShift; k++) {
                    const y = Math.floor(Math.random() * height); // „Ç∫„É©„ÅôË°å„Çí„É©„É≥„ÉÄ„É†„Å´ÈÅ∏„Å∂
                    const shift = Math.floor(Math.random() * maxShift) * 4; // „Ç∫„É¨Èáè („Éî„ÇØ„Çª„É´)
                    if (shift > 0) {
                        const lineOffset = y * width * 4;
                        const lineBuffer = new Uint8ClampedArray(data.slice(lineOffset, lineOffset + width * 4)); // slice„Åß„ÅØ„Å™„ÅèUint8ClampedArray„Åß„Ç≥„Éî„Éº„ÇíÊúÄÈÅ©Âåñ
                        for (let x = 0; x < width * 4; x++) {
                            data[lineOffset + x] = lineBuffer[(x + shift) % (width * 4)];
                        }
                    }
                }
            }

            // --- COLOR BLEED (Ëâ≤„Ç∫„É¨) ---
            if (colorAmount > 0) {
                const shiftAmount = Math.floor(colorAmount / 5); // „Ç∫„É©„ÅôÈáè (1-20„Éî„ÇØ„Çª„É´)
                
                for (let i = 0; i < data.length; i += 4) {
                    const rIndex = (i + shiftAmount * 4) % data.length;
                    let bIndex = (i - shiftAmount * 4);
                    if (bIndex < 0) bIndex = data.length + bIndex;
                    
                    data[i] = data[rIndex]; // Red
                    data[i + 2] = data[bIndex + 2]; // Blue
                }
            }

            // --- STATIC NOISE (Á†ÇÂµê„Éé„Ç§„Ç∫) --- Êñ∞Ë¶è„Ç®„Éï„Çß„ÇØ„Éà
            if (noiseAmount > 0) {
                const noiseDensity = noiseAmount / 100; // 0-1„ÅÆÂØÜÂ∫¶
                for (let i = 0; i < data.length; i += 4) {
                    if (Math.random() < noiseDensity) {
                        const gray = Math.floor(Math.random() * 255);
                        data[i] = gray;     // R
                        data[i + 1] = gray; // G
                        data[i + 2] = gray; // B
                        // data[i + 3] = 255; // A (ÈÄèÊòéÂ∫¶) „ÅØ„Åù„ÅÆ„Åæ„Åæ„Åã„ÄÅ„Éé„Ç§„Ç∫„Å´Âêà„Çè„Åõ„Å¶Ë™øÊï¥
                    }
                }
            }
        }

        // ÂàùÊúüÊèèÁîª„É´„Éº„Éó„ÅÆÈñãÂßã („ÇΩ„Éº„Çπ„Åå‰Ωï„ÇÇ„Å™„Åè„Å¶„ÇÇCanvas„ÅÆÊõ¥Êñ∞„ÅØË°å„ÅÜ)
        // „Åì„Çå„Å´„Çà„Çä„ÄÅÂæå„Åã„Çâ„ÇΩ„Éº„Çπ„ÅåËøΩÂä†„Åï„Çå„ÅüÈöõ„Å´„Çπ„É†„Éº„Ç∫„Å´ÈñãÂßã„Åß„Åç„Çã
        if (!animationFrameId) {
            animationFrameId = requestAnimationFrame(processFrame);
        }
    </script>

</body>
</html>
